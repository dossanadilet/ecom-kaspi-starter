name: ETL Market Snapshot

on:
  schedule:
    # UTC: эти два cron-задания эквивалентны 03:00 и 04:00 по Asia/Almaty (пример)
    - cron: "0 21 30,14 * *" # тяжёлый срез 1 и 15 числа
    - cron: "0 22 * * *" # ежедневный лёгкий апдейт
  workflow_dispatch:

jobs:
  run-etl:
    runs-on: ubuntu-latest

    # прокидываем секреты в переменные окружения для всех шагов
    env:
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install playwright pyyaml beautifulsoup4 lxml pandas
          python -m playwright install --with-deps chromium

      - name: Run ETL
        run: |
          python etl/run_etl.py

      - name: Commit artifacts
        run: |
          git config user.name "etl-bot"
          git config user.email "etl-bot@example.com"
          git add data/latest/market_snapshot.csv data/daily/*.csv || true
          git commit -m "ETL: update market snapshot" || echo "no changes"
          git push

      # ---- УВЕДОМЛЕНИЯ В TELEGRAM ----
      - name: Notify success
        if: ${{ success() }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="✅ ETL обновил <b>market_snapshot.csv</b>"

      - name: Notify failure
        if: ${{ failure() }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="❌ ETL упал. Проверь логи GitHub Actions."
